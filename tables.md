# Big-AGI Database Schema Documentation

This document describes the SQLite database schemas used in Big-AGI for storing chat conversations and metrics data. These schemas can be adapted for other database systems like PostgreSQL, MySQL, or MongoDB.

## Database Files

The Big-AGI application uses multiple SQLite database files:

- **big-agi-chats.db** - Stores conversations, messages, and message fragments (102KB)
- **big-agi-metrics.db** - Stores usage metrics and cost tracking data (4KB)
- **big-agi-llms.db** - Stores LLM services, models, and domain assignments (53KB)
- **big-agi-data.db** - General purpose key-value store for application data (16KB)

---

## Chat Database Schema (chat.db)

### Core Tables

#### `conversations`
Stores chat conversation metadata.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | TEXT | PRIMARY KEY | Unique conversation identifier |
| user_title | TEXT | | User-defined conversation title |
| auto_title | TEXT | | Auto-generated conversation title |
| is_archived | INTEGER | DEFAULT 0 | Archive status (0/1) |
| is_incognito | INTEGER | DEFAULT 0 | Incognito mode flag (0/1) |
| user_symbol | TEXT | | User-defined symbol/icon |
| system_purpose_id | TEXT | NOT NULL | Associated system purpose ID |
| created | INTEGER | NOT NULL | Creation timestamp (Unix) |
| updated | INTEGER | | Last update timestamp (Unix) |
| token_count | INTEGER | DEFAULT 0 | Total tokens in conversation |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | Database creation time |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | Database update time |

#### `messages`
Stores individual messages within conversations.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | TEXT | PRIMARY KEY | Unique message identifier |
| conversation_id | TEXT | NOT NULL, FK → conversations(id) | Parent conversation |
| role | TEXT | CHECK: 'user', 'assistant', 'system' | Message sender role |
| purpose_id | TEXT | | Associated purpose/persona ID |
| token_count | INTEGER | DEFAULT 0 | Token count for this message |
| created | INTEGER | NOT NULL | Creation timestamp (Unix) |
| updated | INTEGER | | Last update timestamp (Unix) |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | Database creation time |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | Database update time |

#### `message_fragments`
Stores message content fragments (text, attachments, etc.).

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | TEXT | PRIMARY KEY (composite) | Fragment identifier |
| message_id | TEXT | PRIMARY KEY (composite), FK → messages(id) | Parent message |
| fragment_type | TEXT | CHECK: 'content', 'attachment', 'void' | Fragment type |
| fragment_order | INTEGER | DEFAULT 0 | Order within message |
| title | TEXT | | Fragment title |
| part_type | TEXT | NOT NULL | Content type (text, image, etc.) |
| part_data | TEXT | NOT NULL | JSON data for the fragment |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | Database creation time |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | Database update time |

### Supporting Tables

#### `message_metadata`
Stores message metadata like references and entanglements.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| message_id | TEXT | PRIMARY KEY, FK → messages(id) | Parent message |
| in_reference_to | TEXT | | JSON array of message references |
| entangled | TEXT | | JSON object for entangled messages |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | Database creation time |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | Database update time |

#### `message_generators`
Stores information about LLM generators used for messages.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| message_id | TEXT | PRIMARY KEY, FK → messages(id) | Parent message |
| llm_id | TEXT | | LLM model identifier |
| llm_label | TEXT | | Human-readable LLM name |
| llm_output_tokens | INTEGER | | Tokens generated by LLM |
| metrics | TEXT | | JSON object with generation metrics |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | Database creation time |

#### `message_user_flags`
Stores user-defined flags for messages.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | Unique flag ID |
| message_id | TEXT | NOT NULL, FK → messages(id) | Parent message |
| flag_type | TEXT | NOT NULL | Type of flag |
| flag_value | TEXT | | Flag value |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | Database creation time |

### Views

#### `conversations_with_stats`
Aggregated view of conversations with message statistics.

```sql
SELECT c.*, COUNT(m.id) as message_count, MAX(m.created) as last_message_time
FROM conversations c
LEFT JOIN messages m ON c.id = m.conversation_id
GROUP BY c.id;
```

#### `messages_complete`
Complete message view with all related data.

```sql
SELECT m.*, md.in_reference_to, md.entangled, mg.llm_id, mg.llm_label, 
       mg.llm_output_tokens, mg.metrics, COUNT(mf.id) as fragment_count
FROM messages m
LEFT JOIN message_metadata md ON m.id = md.message_id
LEFT JOIN message_generators mg ON m.id = mg.message_id  
LEFT JOIN message_fragments mf ON m.id = mf.message_id
GROUP BY m.id;
```

---

## Metrics Database Schema (metrics.db)

### Core Tables

#### `metrics_store`
Stores the complete metrics state as JSON.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | Unique record ID |
| key | TEXT | UNIQUE NOT NULL | Store key identifier |
| data | TEXT | NOT NULL | JSON stringified metrics data |
| version | INTEGER | DEFAULT 1 | Schema version |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | Database creation time |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | Database update time |

#### `metrics_entries`
Individual cost entries for detailed tracking (append-only).

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | Unique entry ID |
| service_id | TEXT | NOT NULL | Service identifier (e.g., 'openai') |
| costs_cents | INTEGER | | Cost in cents |
| savings_cents | INTEGER | | Savings in cents (cached results) |
| cost_code | TEXT | | Cost classification code |
| input_tokens | INTEGER | DEFAULT 0 | Input tokens used |
| output_tokens | INTEGER | DEFAULT 0 | Output tokens generated |
| debug_cost_source | TEXT | | Debug information for cost calculation |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | Database creation time |

#### `service_metrics_aggregates`
Cached aggregate calculations per service.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| service_id | TEXT | PRIMARY KEY | Service identifier |
| total_costs_cents | INTEGER | DEFAULT 0 | Total costs in cents |
| total_savings_cents | INTEGER | DEFAULT 0 | Total savings in cents |
| total_input_tokens | INTEGER | DEFAULT 0 | Total input tokens |
| total_output_tokens | INTEGER | DEFAULT 0 | Total output tokens |
| usage_count | INTEGER | DEFAULT 0 | Number of API calls |
| first_usage_date | INTEGER | DEFAULT 0 | First usage timestamp |
| last_usage_date | INTEGER | DEFAULT 0 | Last usage timestamp |
| free_usages | INTEGER | DEFAULT 0 | Count of free API calls |
| no_pricing_usages | INTEGER | DEFAULT 0 | Count of calls without pricing |
| no_token_usages | INTEGER | DEFAULT 0 | Count of calls without tokens |
| partial_message_usages | INTEGER | DEFAULT 0 | Count of partial messages |
| partial_price_usages | INTEGER | DEFAULT 0 | Count of partial pricing |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | Database update time |

---

## LLM Database Schema (big-agi-llms.db)

### Core Tables

#### `llm_services`
Stores LLM service providers (OpenAI, Anthropic, etc.).

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | TEXT | PRIMARY KEY | Unique service identifier |
| vendor_id | TEXT | NOT NULL | Vendor identifier (e.g., 'openai') |
| label | TEXT | NOT NULL | Human-readable service name |
| setup | TEXT | NOT NULL | JSON configuration object |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | Database creation time |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | Database update time |

#### `llm_models`
Stores individual LLM models available from services.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | TEXT | PRIMARY KEY | Unique model identifier |
| service_id | TEXT | NOT NULL, FK → llm_services(id) | Parent service |
| vendor_id | TEXT | NOT NULL | Vendor identifier |
| label | TEXT | NOT NULL | Model name |
| created | TEXT | NOT NULL | ISO date when model was created |
| updated | TEXT | | ISO date when model was updated |
| description | TEXT | | Model description |
| context_tokens | INTEGER | | Maximum context window size |
| max_output_tokens | INTEGER | | Maximum output tokens |
| training_data_cutoff | TEXT | | ISO date of training data cutoff |
| interfaces | TEXT | NOT NULL | JSON array of supported interfaces |
| input_types | TEXT | | JSON object of supported input types |
| benchmark | TEXT | | JSON object with benchmark scores |
| pricing | TEXT | | JSON object with pricing information |
| initial_parameters | TEXT | | JSON object of default parameters |
| user_parameters | TEXT | | JSON object of user-customized parameters |
| user_label | TEXT | | User-defined custom label |
| user_hidden | INTEGER | DEFAULT 0 | Hide from UI (0/1) |
| user_starred | INTEGER | DEFAULT 0 | User favorite flag (0/1) |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | Database creation time |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | Database update time |

#### `llm_assignments`
Maps application domains to specific models.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| domain_id | TEXT | PRIMARY KEY | Domain identifier (e.g., 'chat', 'reasoning') |
| model_id | TEXT | NOT NULL, FK → llm_models(id) | Assigned model |
| temperature | REAL | | Model temperature setting |
| max_tokens | INTEGER | | Maximum tokens for this domain |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | Database creation time |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | Database update time |

#### `llm_store_metadata`
Stores LLM configuration metadata.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| key | TEXT | PRIMARY KEY | Metadata key |
| value | TEXT | NOT NULL | Metadata value |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | Database update time |

---

## Data Store Schema (big-agi-data.db)

### Core Tables

#### `stores`
General purpose key-value store for application data.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | TEXT | PRIMARY KEY | Unique store identifier |
| name | TEXT | UNIQUE NOT NULL | Store name |
| data | TEXT | NOT NULL | JSON data payload |
| version | INTEGER | DEFAULT 1 | Data schema version |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | Database creation time |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | Database update time |

This table stores various application data including:
- UI preferences and settings
- User interface layouts
- Application configuration
- Feature flags
- User customizations

---

## Database Migration Guide

### From SQLite to PostgreSQL

1. **Data Types:**
   - `TEXT` → `VARCHAR` or `TEXT`
   - `INTEGER` → `INTEGER` or `BIGINT`
   - `DATETIME` → `TIMESTAMP`

2. **Auto-increment:**
   - `INTEGER PRIMARY KEY AUTOINCREMENT` → `SERIAL PRIMARY KEY`

3. **JSON Storage:**
   - Use PostgreSQL's native `JSON` or `JSONB` types instead of `TEXT`

4. **Boolean Values:**
   - Change `INTEGER` (0/1) to `BOOLEAN`

### From SQLite to MySQL

1. **Data Types:**
   - `TEXT` → `TEXT` or `VARCHAR(255)`
   - `INTEGER` → `INT` or `BIGINT`
   - `DATETIME` → `DATETIME`

2. **Auto-increment:**
   - `INTEGER PRIMARY KEY AUTOINCREMENT` → `INT AUTO_INCREMENT PRIMARY KEY`

3. **JSON Storage:**
   - Use MySQL's native `JSON` type (MySQL 5.7+)

4. **Check Constraints:**
   - Replace `CHECK` constraints with triggers or application logic

### From SQLite to MongoDB

1. **Document Structure:**
   ```javascript
   // Conversation document
   {
     _id: "conversation_id",
     userTitle: "string",
     autoTitle: "string", 
     isArchived: false,
     isIncognito: false,
     userSymbol: "string",
     systemPurposeId: "string",
     created: Date,
     updated: Date,
     tokenCount: 0,
     messages: [
       {
         id: "message_id",
         role: "user|assistant|system",
         purposeId: "string",
         tokenCount: 0,
         created: Date,
         updated: Date,
         fragments: [
           {
             id: "fragment_id",
             type: "content|attachment|void",
             order: 0,
             title: "string",
             partType: "string",
             partData: {}
           }
         ],
         metadata: {
           inReferenceTo: [],
           entangled: {}
         },
         generator: {
           llmId: "string",
           llmLabel: "string", 
           llmOutputTokens: 0,
           metrics: {}
         },
         userFlags: [
           {
             type: "string",
             value: "string"
           }
         ]
       }
     ]
   }
   ```

2. **Metrics Document:**
   ```javascript
   {
     _id: "service_id",
     serviceId: "openai",
     totalCostsCents: 0,
     totalSavingsCents: 0,
     totalInputTokens: 0,
     totalOutputTokens: 0,
     usageCount: 0,
     firstUsageDate: Date,
     lastUsageDate: Date,
     entries: [
       {
         costsCents: 125,
         savingsCents: 0,
         costCode: "gpt-4o",
         inputTokens: 150,
         outputTokens: 50,
         debugCostSource: "chat-completion",
         createdAt: Date
       }
     ]
   }
   ```

---

## Indexes and Performance

### Recommended Indexes

**Chat Database (big-agi-chats.db):**
```sql
-- Conversation lookups
CREATE INDEX idx_conversations_created ON conversations(created DESC);
CREATE INDEX idx_conversations_updated ON conversations(updated DESC);

-- Message lookups  
CREATE INDEX idx_messages_conversation ON messages(conversation_id);
CREATE INDEX idx_messages_conversation_created ON messages(conversation_id, created ASC);

-- Fragment lookups
CREATE INDEX idx_fragments_message_order ON message_fragments(message_id, fragment_order ASC);
```

**Metrics Database (big-agi-metrics.db):**
```sql
-- Service lookups
CREATE INDEX idx_metrics_entries_service_id ON metrics_entries(service_id);
CREATE INDEX idx_metrics_entries_created_at ON metrics_entries(created_at);

-- Aggregate lookups
CREATE INDEX idx_service_metrics_aggregates_last_usage ON service_metrics_aggregates(last_usage_date);
```

**LLM Database (big-agi-llms.db):**
```sql
-- Service and model lookups
CREATE INDEX idx_llm_models_service_id ON llm_models(service_id);
CREATE INDEX idx_llm_models_vendor_id ON llm_models(vendor_id);
CREATE INDEX idx_llm_assignments_model_id ON llm_assignments(model_id);
CREATE INDEX idx_llm_services_vendor_id ON llm_services(vendor_id);
```

**Data Store Database (big-agi-data.db):**
```sql
-- Store name lookups
CREATE INDEX idx_stores_name ON stores(name);
CREATE INDEX idx_stores_updated_at ON stores(updated_at DESC);
```

### Performance Considerations

1. **Conversation Loading:** Use pagination for large conversation lists
2. **Message Streaming:** Load messages incrementally for long conversations  
3. **Metrics Aggregation:** Use cached aggregates instead of real-time calculations
4. **JSON Storage:** Consider separate columns for frequently queried JSON fields
5. **Backup Strategy:** Implement regular backups due to append-only metrics design

---

## Cost Codes Reference

The `cost_code` field in `metrics_entries` uses these standardized values:

- `'free'` - Free API call
- `'no-pricing'` - No pricing information available
- `'no-tokens'` - No token information available  
- `'partial-msg'` - Partial message (incomplete)
- `'partial-price'` - Partial pricing information
- Model names (e.g., `'gpt-4o'`, `'gpt-3.5-turbo'`) - Successful pricing

This schema supports the full Big-AGI feature set while remaining flexible for database migration and scaling needs.